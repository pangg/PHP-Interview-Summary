高并发和大流量

1. 并发
    * 并发访问，在某个时间点，有多少个访问同时到来
    * 通常如果一个系统的日pv在千万以上，有可能是一个高并发系统

    * QPS：每秒钟请求或者查询的数量，在互联网领域，指每秒响应请求数（http请求）
    * 吞吐量：单位时间内处理的请求数量（通常由qps与并发数决定）
    * 响应时间：从发送请求到收到响应花费的时间。
    * PV：综合浏览量，即页面浏览量或者点击量，一个访客在24小时的页面访问数量;
        同一个人浏览网站的同一页面，只记作一次PV
    * UV：独立访客，即一定时间范围内相同访客多次访问网站，只计算为1个独立访客

2. 高并发应关心的问题
    * 带宽：计算带宽大小需要关注两个指标，峰值流量和页面的平均大小
    * 日网站带宽 = PV / 统计时间（换算到秒） * 平均页面大小（单位KB） * 8
    * 峰值一般是平均值的倍数，根据实际情况来定

    * QPS不等于并发连接数
    * QPS是每秒HTTP请求数，并发连接数是系统同时处理请求数量
    ```
        ( 总PV数 * 80% ) / ( 每天秒数 * 20% ) = 峰值时间每秒请求数(QPS)
        80%的访问量集中在20%的时间
        每天300w PV 的在单台机器上，这台机器需要多少QPS？
        ( 3000000 * 0.8 ) / (86400 * 0.2 ) = 139 (QPS)。
    ```
3. 压力测试
    * 测试能承受的最大并发
    * 测试最大承受的QPS

    * 常用压力测试工具：
        * ab， http_load, apache JMeter

    * ab使用：
        * 创建多个并发访问线程，模拟多个访问者同时对某一URL地址进行访问。

        * 模拟并发请求100次，总共请求5000次
            * ab -c 100 -n 5000 待测试网站

        * 注意事项：
            * 测试机器与被测试机器分开
            * 不要对线上服务做压力测试
            * 观察测试工具ab所在机器，以及被测试的前端机的cpu，内存，网络等都不超过最高限度的75%

4.
    * QPS达到50：
        * 可以称为小型网站，一般的服务器就可以应对
    * QPS达到100：
        * 假设关系型数据库每次请求在0.01秒完成;
            假设单页面只有一个sql查询，那么100QPS意味着1秒钟完成100次请求;
            但是此时我们并不能保证数据库查询能完成100次
        * 方案：数据库缓存层、数据库的负载均衡
    * QPS达到800：
        * 假设使用百兆带宽，意味着网站出口的实际带宽是8M左右;
            假设每个页面只有10K，在这个并发条件下，百兆带宽已经吃完;
        * 方案：CDN加速、负载均衡
    * QPS达到1000：
        * 假设使用Memcache缓存数据库查询，每个页面对Memcache的请求远大于直接对DB的请求;
            Memcache的悲观并发数在2W左右，但有可能在之前内网带宽已经吃光，表现出不稳定;
        * 方案：静态HTML缓存
    * QPS达到2000：
        * 这个级别下，文件系统访问锁都成为了灾难
        * 方案：做业务分离，分布式存储


5. 优化方案
    * 流量优化（防盗链处理）
    * 前端优化（减少HTTP请求，添加异步请求，启用浏览器缓存和文件压缩，CDN加速，建立独立的图片服务器）
    * 服务端优化（页面静态化，并发处理，队列处理）
    * 数据库优化（数据库缓存，分库分表、分区操作，读写分离，负载均衡）
    * web服务器优化（负载均衡）






















